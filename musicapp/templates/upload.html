{% extends "layout.html" %}
 
{% block content %}
  <h2>Upload a song</h2>
  <form action="{{ url_for('upload') }}" method=post enctype="multipart/form-data">
    {{ form.hidden_tag() }}
     
    {{ form.name.label }}
    {{ form.name }}
     
    {{ form.artist.label }}
    {{ form.artist }}
        
    {{ form.album.label }}
    {{ form.album }}
    
    {{ form.f.label }}
    {{ form.f }}
    <br>
    <br>
    
    {{ form.submit }}
  </form>
  
  
  <script>
    function createCORSRequest(method, url) {
      var xhr = new XMLHttpRequest();
      if ("withCredentials" in xhr) {

       // Check if the XMLHttpRequest object has a "withCredentials" property.
       // "withCredentials" only exists on XMLHTTPRequest2 objects.
       xhr.open(method, url, true);

     } else if (typeof XDomainRequest != "undefined") {

       // Otherwise, check if XDomainRequest.
       // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
       xhr = new XDomainRequest();
       xhr.open(method, url);

    } else {

       // Otherwise, CORS is not supported by the browser.
       xhr = null;

    }
    return xhr;
 }
    (function() {
    document.getElementById("f").onchange = function(){
        var files = document.getElementById("f").files;
        var file = files[0];
        if(file == null){
            alert("No file selected.");
        }
        else{
            get_signed_request(file);
        }
      };
    })();
    function get_signed_request(file){
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/sign_s3?file_name="+file.name+"&file_type="+file.type);
    xhr.onreadystatechange = function(){
        if(xhr.readyState === 4){
            if(xhr.status === 200){
                var response = JSON.parse(xhr.responseText);
                upload_file(file, response.signed_request, response.url);
            }
            else{
                alert("Could not get signed URL.");
            }
          }
        };
      xhr.send();
    }
    function upload_file(file, signed_request, url){
    
    var xhr = new XMLHttpRequest();
    //var xhr = createCORSRequest("PUT", signed_request);
    //if (!xhr)
    //  console.log("cors not supported");
    xhr.open("PUT", signed_request);
    xhr.setRequestHeader('x-amz-acl', 'public-read');
    xhr.setRequestHeader('access-control-allow-origin','*');
    xhr.onload = function() {
        if (xhr.status === 200) {
            console.log(url);
        }
        };
        xhr.onerror = function() {
         alert("Could not upload file.");
         };
        xhr.send(file);
    }
  </script>
{% endblock %}